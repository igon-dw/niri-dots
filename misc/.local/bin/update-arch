#!/usr/bin/env bash

# Arch Linux System Update Script
# UNIX philosophy: simple, explicit, readable

# --- Safety Settings ---
set -uo pipefail

# --- Constants ---
readonly LOG_FILE="${HOME}/.local/state/update-arch/log.txt"
readonly BLUE='\033[1;34m'
readonly YELLOW='\033[1;33m'
readonly BOLD='\033[1m'
readonly NC='\033[0m'

# --- Helper Functions ---

# Display last run from log
log_init() {
    mkdir -p "$(dirname "$LOG_FILE")"
    if [[ -f "$LOG_FILE" ]]; then
        echo "[Last run] $(tail -n 1 "$LOG_FILE")"
    fi
}

# Print section header with visual separator
header() {
    echo -e "\n${BLUE}${BOLD}:: $1${NC}"
    echo -e "${BLUE}$(printf '%.0s-' {1..60})${NC}"
}

# Get free disk space in GB with one decimal place
get_free_gb() {
    df -BG / | awk 'NR==2 {gsub(/G/, "", $4); printf "%.1f", $4}'
}

# Prompt for cache cleanup
prompt_cache_cleanup() {
    local tool=$1
    read -p "Clear cache for ${tool}? (y/N): " -r
    if [[ $REPLY =~ ^[yY]$ ]]; then
        "$tool" -Sc || true
        # Workaround: remove stale pacman sandbox temp dirs left by interrupted downloads
        # (pacman v6.1+ creates download-XXXXXX dirs that may not be cleaned up on abort)
        echo -e "${YELLOW}${BOLD}[WARN]${NC}${YELLOW} Stale download-* dirs in /var/cache/pacman/pkg/ can cause errors on next -Sc${NC}"
        read -p $'\033[1;33m[WARN]\033[0m Remove stale /var/cache/pacman/pkg/download-* dirs? (y/N): ' -r
        [[ $REPLY =~ ^[yY]$ ]] && sudo rm -rf /var/cache/pacman/pkg/download-* || true
    fi
}

# --- Main Flow ---

log_init

# Confirm before starting
read -p "Start system update? (y/N): " -r
if [[ ! $REPLY =~ ^[yY]$ ]]; then
    echo "Update cancelled."
    exit 0
fi

status="success"

# Run a command and mark status as fail on error (non-fatal)
run() {
    "$@" || status="fail"
}

# System update: priority order yay > paru > pacman
if command -v yay &>/dev/null; then
    header "yay System Update"
    run yay -Syu
    cache_tool="yay"
elif command -v paru &>/dev/null; then
    header "paru System Update"
    run paru -Syu
    cache_tool="paru"
else
    header "pacman System Update"
    run sudo pacman -Syu
    cache_tool=""
fi

# npm: update global packages and audit
if command -v npm &>/dev/null; then
    header "npm Global Package Update & Audit"
    run npm update -g
    run npx --yes npm-global-audit
fi

# ClamAV: update virus definitions
if command -v freshclam &>/dev/null; then
    header "ClamAV Virus Definitions Update"
    run sudo freshclam
fi

# Flatpak: update and cleanup
if command -v flatpak &>/dev/null; then
    header "Flatpak Update & Cleanup"
    run flatpak update -y
    run flatpak uninstall --unused -y
fi

# Neovim: sync plugins with Lazy.nvim
if command -v nvim &>/dev/null; then
    header "Neovim Plugin Sync"
    run nvim --headless "+Lazy! sync" +qa
fi

# Cache cleanup (delayed to avoid temp file conflicts)
if [[ -n "${cache_tool:-}" ]]; then
    header "Package Cache Cleanup"
    prompt_cache_cleanup "$cache_tool"
fi

echo -e "\n${BLUE}:: All updates are complete${NC}"

# Record to log
free_gb=$(get_free_gb)
echo "$(date '+%Y-%m-%d %H:%M:%S') JST | status: $status | free: ${free_gb}GB" >> "$LOG_FILE"
